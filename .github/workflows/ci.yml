name: CI

on:
  push:
    branches: [master]
    paths:
      - "**/*.py"
  pull_request:
    branches: [master]
    paths:
      - "**/*.py"

jobs:
  test:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - python-version: "2.7"
            os: ubuntu-22.04
          - python-version: "3.8"
            os: ubuntu-latest
          - python-version: "3.9"
            os: ubuntu-latest
          - python-version: "3.10"
            os: ubuntu-latest
          - python-version: "3.11"
            os: ubuntu-latest
          - python-version: "3.12"
            os: ubuntu-latest
          - python-version: "3.13"
            os: ubuntu-latest
          - python-version: "3.14"
            os: ubuntu-latest

    services:
      flaresolverr:
        image: ghcr.io/flaresolverr/flaresolverr:latest
        ports:
          - 8191:8191
        env:
          LOG_LEVEL: info

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        if: matrix.python-version != '2.7'
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Set up Python 2.7
        if: matrix.python-version == '2.7'
        run: |
          sudo apt-get update
          sudo apt-get install -y python2 python2-dev
          curl https://bootstrap.pypa.io/pip/2.7/get-pip.py -o get-pip.py
          python2 get-pip.py
          echo "$(python2 -m site --user-base)/bin" >> $GITHUB_PATH

      - name: Install dependencies (Python 2.7)
        if: matrix.python-version == '2.7'
        run: |
          python2 -m pip install --upgrade pip setuptools wheel
          python2 -m pip install requests mock "pytest<5" coverage

      - name: Install dependencies (Python 3.x)
        if: matrix.python-version != '2.7'
        run: |
          python -m pip install --upgrade pip setuptools wheel
          python -m pip install -e ".[dev]"
          python -m pip install coverage

      - name: Run tests with coverage (Python 2.7)
        if: matrix.python-version == '2.7'
        env:
          FLARESOLVERR_URL: http://localhost:8191/v1
        run: |
          python2 -m coverage run -m pytest tests/ -v
          python2 -m coverage xml -o coverage-py27.xml

      - name: Run tests with coverage (Python 3.x)
        if: matrix.python-version != '2.7'
        env:
          FLARESOLVERR_URL: http://localhost:8191/v1
        run: |
          python -m coverage run -m pytest tests/ -v
          python -m coverage xml -o coverage-py${{ matrix.python-version }}.xml

      - name: Upload coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage-${{ matrix.os }}-${{ matrix.python-version }}
          path: coverage-*.xml
          retention-days: 1

  upload-coverage:
    name: Upload Combined Coverage
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download all coverage artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: coverage-*
          merge-multiple: true

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage-*.xml
          fail_ci_if_error: false
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
